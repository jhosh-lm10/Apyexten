console.log("APYSKY: Content Script inicializado en:",window.location.href);console.log("APYSKY: Content Script cargado en WhatsApp Web");function s(){if(!document.querySelector('header[data-testid="conversation-header"]'))return null;const t=document.querySelector('div[data-testid="conversation-panel-wrapper"]');if(!t)return null;const n=t.getAttribute("data-id");return n?n.split("@")[0]:null}async function l(e,t=1e4){const n=Date.now();for(;Date.now()-n<t;){const o=document.querySelector(e);if(o)return o;await new Promise(r=>setTimeout(r,100))}throw new Error(`Elemento no encontrado: ${e}`)}async function u(e){try{console.log("APYSKY: Intentando enviar mensaje:",e);const t=await l('div[title="Escribe un mensaje aquí"]');console.log("APYSKY: Campo de entrada encontrado"),t.focus(),t.click(),t.textContent=e;const n=new InputEvent("input",{bubbles:!0,inputType:"insertText",data:e});t.dispatchEvent(n),await new Promise(r=>setTimeout(r,100));const o=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0});return t.dispatchEvent(o),console.log("APYSKY: Mensaje enviado con éxito"),!0}catch(t){return console.error("APYSKY: Error en sendMessageToCurrentChat:",t),!1}}chrome.runtime.onMessage.addListener((e,t,n)=>{if(console.log("APYSKY: Mensaje recibido en content script:",e),e.action==="SEND_MESSAGE"){const{message:o,to:r}=e.payload,a=s(),i=r.replace(/[^0-9]/g,"");if(a&&a.includes(i))return u(o).then(c=>{n({success:c,error:c?null:"No se pudo enviar el mensaje"})}),!0;n({success:!1,error:"No se pudo cambiar al chat de destino. Por favor, abre el chat manualmente."})}return e.action&&n({success:!1,error:`Acción no soportada: ${e.action}`}),!0});console.log("APYSKY: Content Script listo");
